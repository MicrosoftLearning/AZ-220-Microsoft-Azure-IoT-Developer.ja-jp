---
lab:
  title: 'ラボ 08: Power BI でデータ ストリームを視覚化する'
  module: 'Module 5: Insights and Business Integration'
ms.openlocfilehash: 813379621c30c500b0569cfb4587ffcd3f6f7de3
ms.sourcegitcommit: 06dc1e6caa88a09b1246dd1161f15f619db9c6f8
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/10/2022
ms.locfileid: "145883697"
---
# <a name="visualize-a-data-stream-in-power-bi"></a>Power BI でデータ ストリームを視覚化する

> **重要**:このラボには、コース用に提供された Azure サブスクリプションとは関係なく、次のように複数のサービスの前提条件があります。
>
> 1. "職場または学校アカウント" にサインインする機能 (Azure Active Directory アカウント)
> 2. アカウントのサインイン名を知っている必要があります。ただし、電子メール アドレスと一致しない場合があります。
> 3. Power BI へのアクセスは、次の方法で行われます。
>       1. 既存の Power BI アカウント
>       2. Power BI にサインアップする機能 - 一部の組織はこれをブロックします。
>
> 最初のラボの演習では、Power BI にアクセスする機能を検証します。  最初の演習で成功しなかった場合は、職場または学校のアカウントに対してブロックされたアクセスに対する簡易的な回避策がないため、ラボを完了できません。

## <a name="lab-scenario"></a>課題シナリオ

Contoso のチーズ パッケージング プロセスで使用されるコンベア ベルト システムの典型的な振動データとその他のテレメトリ出力を生成する、シミュレートされた IoT デバイスを開発しました。 Azure BLOB ストレージにデータを送信するログ ルートを構築して、テストしました。 テレメトリ データを Azure Event Hubs サービスに送信する IoT Hub 内の新しいルートの作業を開始します。

Azure IoT Hub と Azure Event Hubs の主な違いは、Event Hubs はビッグ データ ストリーミングのために設計されているのに対して、IoT Hub は IoT ソリューションに最適化されている点です。 どちらのサービスも、低遅延と高い信頼性でデータの取り込みをサポートします。 Azure Event Hubs では IoT Hub と似た方法による Stream Analytics の入力を提供するため、この場合には、選択した Event Hubs により、ソリューション内の追加の Azure サービス オプションを探索できます。

### <a name="make-a-call-to-a-built-in-machine-learning-model"></a>組み込みの機械学習モデルへの呼び出し

このラボでは、`AnomalyDetection_SpikeAndDip` という名前の組み込みの機械学習 (ML) 関数を呼び出します。 `AnomalyDetection_SpikeAndDip` 関数では、スライディング ウィンドウを使用してデータの異常を分析します。 スライディング ウィンドウは、たとえば、直近の 2 分間のテレメトリ データなどである場合があります。 ウィンドウは、テレメトリの流れに合わせてほぼリアルタイムで進みます。 一般的に、スライディング ウィンドウのサイズを大きくしてより多くのデータを含めると、異常検出の精度も向上します (ただし、遅延も増加するため、バランスをとる必要があります)。

この関数は、データの "正常な" 範囲を確立し、それを使用して異常を識別し、評価を割り当てます。 これは次のように機能します。関数がデータの流れを監視し続けると、アルゴリズムは通常の値の範囲を確立し、新しい値をそれらの基準と比較します。 結果は各値のスコアであり、指定された値が異常であることを示す信頼度レベルを決定する割合として表されます。 ご想像のとおり、低い信頼水準は無視できますが、信頼値の割合が許容できるかどうか疑問に思うかもしれません。 クエリでは、この転換点を 95% に設定します。

データにギャップがある (コンベヤ ベルトがしばらく停止している可能性がある) 場合などは、通常、複雑になります。 アルゴリズムでは、値を入力することで、データの差異を処理します。

> **注**:統計では、補完は欠損データを代入値に置き換えるプロセスになります。 代入について詳しくは、[こちら](https://en.wikipedia.org/wiki/Imputation_%28statistics%29)をご覧ください。

テレメトリ データの急上昇と急降下は一時的な異常です。 ただし、正弦波を使用して振動データをシミュレートしているため、"通常の" 値の後に異常アラートをトリガーする高い値または低い値が続くことが予想されます。 オペレーターは、短い期間に発生する異常のクラスターを見つける場合があります。これは、何かが間違っていることを示します。

傾向を検出するためのモデルなど、他の組み込みの ML モデルもあります。 このモジュールの一部として、これらのモデルは含まれていませんが、さらに調べることを受講者にお勧めします。

### <a name="visualize-data-using-power-bi"></a>Power BI を使用してデータを視覚化する

数値データ (特にその量) を視覚化することは、それ自体が課題となります。 問題が発生したことを推測する一連の異常について、人間のオペレーターに警告するにはどうすればよいですか?

このモジュールに使用するソリューションは、Power BI が取得できるリアルタイム形式のデータを送信するために、Azure Stream Analytics の機能と共に、Power BI の一部の組み込み機能を使用することです。

Power BI のダッシュボード機能を使用して、多くのタイル を作成します。 1 つのタイルには、実際の振動測定値が含まれます。 もう 1 つのタイルはゲージで、値が異常であることを示す 0.0 から 1.0 の信頼度レベルが表示されます。 3 番目のタイルは、95% の信頼度レベルに達したかどうかを示します。 最後に、4 番目のタイルは、過去 1 時間で検出された異常の数を示します。 X 軸として時間を含めることによって、このタイルは、複数の異常が水平に一緒にクラスタリングされるため、短時間で連続して検出されたかどうかを明確にします。

4 番目のタイルを使用すると、テレメトリ コンソール ウィンドウ内の赤いテキストと異常を比較できます。 強制振動または増幅振動、あるいはその両方が発生したときに、一連の異常が検出されますか?

次のリソースが作成されます。

![ラボ 8 アーキテクチャ](media/LAB_AK_08-architecture.png)

## <a name="in-this-lab"></a>このラボでは

このラボでは、次のタスクを正常に達成します。

* ラボの前提条件が満たされていることを確認する (必要な Azure リソースがあること)
* Power BI へのサインアップ
* シミュレートされたデバイスからテレメトリを生成する
* リアルタイムでテレメトリを分析する
* Azure Event Hubs サービスを作成する
* リアルタイム メッセージ ルートの作成
* IoT Hub にテレメトリ ルートを追加する
* データ異常を視覚化する Power BI ダッシュボードの作成

イベント ハブを作成し、2 番目のルートを作成して、SQL クエリを更新し、Power BI ダッシュボードを作成して、すべて実行できるようにしましょう。

## <a name="lab-instructions"></a>ラボの手順

### <a name="exercise-1-verify-lab-prerequisites"></a>演習 1:ラボの前提条件を確認する

このラボでは、次の Azure リソースが利用可能であることを前提としています。

| リソースの種類 | リソース名 |
| :-- | :-- |
| リソース グループ | rg-az220 |
| IoT Hub | iot-az220-training-{your-id} |
| デバイス ID | sensor-v-3000 |
| ストレージ アカウント名 | vibrationstore{your-id} |
| ストレージ コンテナー | vibrationcontainer |
| イベント ハブの名前空間 | vibrationNamespace{your-id} |
| イベント ハブ名 | vibrationeventhubinstance |
| ストリーミング ジョブ | vibrationJob |
| ストリーミング ジョブの入力 | vibrationInput |
| ストリーミング ジョブの出力 | vibrationOutput |
| ストリーミング ジョブの変換 | VibrationJobTransformation |

これらのリソースを確実に使用できるようにするには、次のタスクを行います。

1. **[Azure に配置する]** を選択します。

    [![Azure へのデプロイ](media/deploytoazure.png)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FMicrosoftLearning%2FAZ-220-Microsoft-Azure-IoT-Developer%2Fbicep%2FAllfiles%2FARM%2Flab08.json)

1. プロンプトが表示されたら、**Azure Portal** にログインします。

    **[カスタム デプロイ]** ページが表示されます。

1. **[プロジェクトの詳細]** の **[サブスクリプション]** ドロップダウンで、このコースで使用する [Azure サブスクリプション] が選択されていることを確認します。

1. **[リソース グループ]** ドロップダウンで、 **[rg-az220]** を選択します。

    > **注**:**rg-az220** がリストにない場合:
    >
    > 1. **[リソース グループ]** ドロップダウンで、 **[新規作成]** をクリックします。
    > 1. **[名前]** に「**rg-az220**」と入力します。
    > 1. **[OK]** をクリックします。

1. **[インスタンスの詳細]** の **[リージョン]** ドロップダウンで、最も近いリージョンを選択します。

    > **注**:**rg-az220** グループが既に存在する場合、 **[リージョン]** フィールドは、リソース グループで使用されるリージョンに設定され、読み取り専用になります。

1. **[Your ID]\(ユーザー ID\)** フィールドに、演習 1 で作成した一意の ID を入力します。

1. **[コース ID]** フィールドに、「**az220**」と入力します。

1. テンプレートを検証するには、 **[確認および作成]** をクリックします。

1. 検証に成功したら、 **[作成]** をクリックします。

    デプロイが開始されます。

1. デプロイが完了した後、テンプレートの出力値を確認するには、左側のナビゲーション領域で **[出力]** をクリックします。

    後で使用するために出力をメモしておきます。

    * connectionString
    * deviceConnectionString
    * devicePrimaryKey
    * eventHubEndPoint
    * eventHubPath
    * serviceKey

これで、リソースが作成されました。
### <a name="exercise-2-sign-up-for-power-bi"></a>演習 2:Power BI へのサインアップ

Power BI は、個人用データ分析および視覚エフェクト ツールのほか、グループ プロジェクト、部門、または会社全体の背後にある分析および意思決定エンジンとしても使用できます。 後ほどこのラボで、Power BI を使用してダッシュボードを構築し、データを視覚化します。 この演習では、個人として Power BI にサインアップする方法を説明します。

>**注:**  既に Power BI サブスクリプションをお持ちで、このコース中にそれを使用できる場合は、演習 2 にスキップできます。

#### <a name="task-1-understand-supported-email-addresses"></a>タスク 1:サポートされる電子メール アドレスについて

サインアップ プロセスを開始する前に、Power BI へのサインアップに使用できるメール アドレスの種類を理解しておくことが重要です。

* Power BI では、職場または学校のメール アドレスを使用する必要があります。 コンシューマー メール サービスまたは通信プロバイダーが提供しているメール アドレスではサインアップできません。 これには、outlook.com、hotmail.com、gmail.com などが含まれます。

* サインアップ後は個人アカウントなど、メール アドレスの種類を問わず、[ゲスト ユーザーを招待](https://docs.microsoft.com/azure/active-directory/active-directory-b2b-what-is-azure-ad-b2b)し、自分の Power BI コンテンツを見せることができます。

* .gov または .mil のアドレスで Power BI にサインアップすることはできますが、プロセスが異なります。 詳細については、「[Power BI サービスに米国政府組織を登録する](https://docs.microsoft.com/en-us/power-bi/service-govus-signup)」を参照してください。

#### <a name="task-2-sign-up-for-a-power-bi-account"></a>タスク 2:Power BI アカウントにサインアップする

Power BI アカウントには、以下の手順でサインアップします。 このプロセスが完了すると、Power BI Free ライセンスが与えられます。このライセンスの下で、マイ ワークスペースを使って Power BI を自分で試用したり、Power BI Premium 容量に割り当てられた Power BI ワークスペースのコンテンツを利用したり、個人用 Power BI Pro 試用版を開始したりすることができます。

1. ブラウザーで、[サインアップ ページ](https://signup.microsoft.com/signup?sku=a403ebcc-fae0-4ca2-8c8c-7a907fd6c235)に移動します。

1. **[はじめに]** ページで、サポートされているメール アドレスを入力します。

1. ロボットではないことを証明するよう求めるメッセージが表示された場合は、 **[テキスト メッセージを送信する]** または **[電話で確認コードを受け取る]** のいずれかを選択し、関連情報を入力して確認コードを受け取ってから、この手順の次のステップに進みます。

    ![あなたはロボットではありませんか](./media/LAB_AK_08-prove-robot.png)

    代わりに、既にアカウントを持っているという通知が表示された場合は、サインインを続行すると、Power BI を使用する準備が整います。

    ![あなたはロボットではありませんか](./media/LAB_AK_08-existing-account.png)

1. 電話のテキストを確認するか、電話を待ってから受信したコードを入力して、 **[サインアップ]** をクリックします。

    ![サインアップ](./media/LAB_AK_08-sign-up.png)

1. 次のようなメッセージが届いていないかメールを確認します。

    ![サインアップ](./media/LAB_AK_08-email-verification.png)

1. 次の画面で自分の情報とメールに記載されている確認コードを入力します。 リージョンを選択し、この画面からリンク先に移動してポリシーを確認し、[開始] を選択します。

    ![サインアップ](./media/LAB_AK_08-create-account.png)

1. [Power BI のサインイン ページ](https://powerbi.microsoft.com/landing/signin/)に移動したら、Power BI の使用を開始できます。

Power BI にアクセスできるので、リアルタイムのテレメトリ データを Power BI ダッシュボードにルーティングする準備が整いました。

### <a name="exercise-3-generate-telemetry-from-simulated-device"></a>演習 3:シミュレートされたデバイスからテレメトリを生成する

Power BI ダッシュボードで IoT Hub のライブ ストリーミング データを視覚化するには、テレメトリ メッセージを送信する実際の IoT デバイスまたはシミュレートされた IoT デバイスが必要です。 幸いにも、ラボ 7 でこの要件を満たすシミュレートされたデバイスを作成しました。

この演習では、前のラボの Device Simulator アプリが実行されていることを確認します。

> **重要**: このコースのラボ 7 を完了していない場合は、それを今実行します。

#### <a name="task-1-start-the-vibrationdevice-app-in-visual-studio-code"></a>タスク 1:Visual Studio Code で VibrationDevice アプリを起動する

1. Visual Studio Code を開きます。

1. **[ファイル]** メニューで、 **[フォルダーを開く]** をクリックします。

1. **[フォルダーを開く]** ダイアログで、ラボ 8 のスターター フォルダーに移動します。

    "_ラボ 3:開発環境の設定_" では、ZIP ファイルをダウンロードしてコンテンツをローカルに抽出することで、ラボ リソースを含む GitHub リポジトリをクローンしました。 抽出されたフォルダー構造には、次のフォルダー パスが含まれます。

    * すべてのファイル
      * ラボ
          * 08-Power BI でデータ ストリームを視覚化する
            * スターター

1. **[VibrationDevice]** をクリックし、 **[フォルダーの選択]** をクリックします。

    [エクスプローラー] ペインの一覧に Program.cs と VibrationDevice.csproj ファイルが表示されます。

1. **[エクスプローラー]** ペインで、 **[Program.cs]** をクリックします。

1. コード エディター ペインで、接続文字列変数`deviceConnectionString` が正しく割り当てられていることを確認します。

    IoT Hub で sensor-v-3000 デバイスの接続文字列を見つけるか、完了した Lab7 プロジェクトを確認できます。

    コード内の変数の割り当ては、次のようになります。

    ```csharp
    deviceConnectionString = "HostName=iot-az220-training-cah200509.azure-devices.net;DeviceId=sensor-v-3000;SharedAccessKey=nSUbphUKsS1jEd7INrEtmVWZesMBDIxzjVe4jn01KJI=";
    ```

1. **[ファイル]** メニューの **[保存]** をクリックします。

1. **[表示]** メニューの **[ターミナル]** をクリックします。

    コマンド プロンプトに **vibrationdevice** フォルダーへのフォルダー パスが表示されていることを確認します。

1. ターミナルでアプリを実行するには、次のコマンドを入力します。

    ```bash
    dotnet run
    ```

   このコマンドにより、現在のフォルダーにある **Program.cs** ファイルが実行されます。

1. すぐに次のようなコンソール出力が表示されます。

    ![コンソール出力](./media/LAB_AK_08-vibration-telemetry.png)

    > **注**:緑色のテキストは、物事が本来のように機能していることを示すために使用され、赤いテキストは悪いことが起こっているときに表示されます。 この画像のような画面が表示されない場合は、まず、デバイスの接続文字列を確認してください。

1. このアプリを実行したままにします。

    テレメトリ データは、データの視覚化に必要です。

### <a name="exercise-4-create-an-azure-event-hubs-service"></a>演習 4:Azure Event Hubs サービスを作成する

IoT Hub にテレメトリ データをストリーミングしたので、Azure Event Hubs の名前空間と Azure Event Hubs インスタンスをソリューションに追加します。 Azure Event Hubs はストリーミング データの処理に最適で、ライブ ダッシュボード シナリオをサポートするため、振動データを Power BI に渡す場合に最適です。

#### <a name="task-1-create-an-event-hubs-namespace"></a>タスク 1:Event Hubs 名前空間を作成

このタスクでは、Azure portal を使用して Event Hubs リソースを作成します。

1. Azure アカウントの資格情報を使用して [portal.azure.com](https://portal.azure.com) にログインします。

    複数の Azure アカウントをお持ちの場合は、このコースで使用するサブスクリプションに関連付けられているアカウントを使用してログインしていることを確認してください。

1. Azure portal メニューで、 **[すべてのサービス]** をクリックします。

1. [検索] テキスト ボックスに、「**イベント**」と入力します。

1. 検索テキスト ボックスの下の検索結果パネルで、 **[Event Hubs]** をクリックします。

1. 新しい Event Hubs リソースの作成プロセスを開始するには、 **[イベント ハブの名前空間の作成]** をクリックします。

    **[名前空間の作成]** ブレードが表示されます。

1. **[名前空間の作成]** ブレードで、このコースで使用している値を使用して **[サブスクリプション]** フィールドと **[リソース グループ]** フィールドを構成します。

    リソース グループは、IoT Hub やその他のリソースに使用したものと同じリソースグループ (**rg-az220**) である必要があります。

1. **[名前空間名]** フィールドに「**vibrationNamespace**」と入力し、一意の識別子 {your-id} を入力します。

    例: **vibrationNamespacecah191212**

    この名前はグローバルに一意である必要があります。

1. **[場所]** で、このコースの他のラボで使用しているのと同じ地域を選択します。

1. **[価格レベル]** ドロップダウンで、 **[Standard]** をクリックします。

   > **注**:標準価格レベルを選択すると、_Kafka_ が有効になります。 Kafka 機能用 Event Hubs は、Azure Event Hubs 上で、Kafka トピックに対する読み取りと書き込みの両方について、Kafka バージョン 1.0 以降とバイナリ互換性のあるプロトコル ヘッドを提供します。 Event Hubs と Apache Kafka の詳細については、[こちら](https://docs.microsoft.com/en-us/azure/event-hubs/event-hubs-for-kafka-ecosystem-overview)を参照してください。 このラボでは Kafka を使用しません。

1. **[スループット単位]** フィールドで、値が 1 に設定されていることを確認します。

    このラボでは、ユニット数の増加を保証するのに十分なデータが生成されません。

1. **[自動拡張を有効にする]** はオフのままにしておきます。

    > **注**:自動拡張は、トラフィックが割り当てられたスループット ユニットの容量を超えると、Event Hubs 名前空間に割り当てられたスループット ユニットの数を自動的にスケーリングします。 名前空間を自動的にスケーリングするための制限を指定できます。 このラボでは、この機能は必要ありません。

1. ブレードの最下部で、 **[Review + create]** をクリックします。

    検証が成功したことを示すメッセージが表示されます。 そうでない場合は、指定された問題に対処する必要があります。

1. リソースを作成するには、 **[作成]** をクリックし、リソースのデプロイを待ちます。

    このデプロイには数分かかります。 [通知] ウィンドウを開いて、進行状況を監視できます。

    Event Hubs 名前空間を作成したら、Event Hubs インスタンスを作成できます。

#### <a name="task-2-create-an-event-hubs-instance"></a>タスク 2:Event Hubs インスタンスを作成する

1. Azure portal ダッシュボード のページに戻ります。

1. リソース タイルで、**vibrationNamespace{your-id}** をクリックします。

    Event Hubs の名前空間が一覧にない場合は、タイルを更新します。

    **[Event Hubs の名前空間]** ブレードの **[概要]** ウィンドウが表示されます。

1. Event Hubs インスタンスを作成するには、ウィンドウの上部にある **[+ Event Hub]** をクリックします。

    **[イベント ハブの作成]** ブレードが表示されます。

1. **[イベント ハブの作成]** ブレードで、 **[名前]** の下に「**vibrationeventhubinstance**」と入力します。

1. **[パーティション数]** を **1** に設定したままにします。

    > **注**:パーティションは、アプリケーションの使用に必要なダウンストリーム並列処理に関連するデータ編成メカニズムです。 イベント ハブでのパーティションの数は、予想される同時接続のリーダー数に直接関連します。 Event Hubs チームに連絡すれば、パーティションの数を 32 より大きくすることができます。 パーティションの数は変更できないため、設定については長期的な規模で検討する必要があります。 このラボでは、1 つだけ必要です。

1. **[メッセージのリテンション期間]** は **1** のままにします。

    > **注**:これは、イベントの保持期間です。 保持期間は 1 日から 7 日の間で設定できます。 このラボでは、最小限のリテンション期間のみが必要です。

1. **[キャプチャ]** は **[オフ]** に設定したままにします。

    > **注**:Azure Event Hubs を使用すると、Event Hubs のストリーミング データを選択した Azure Blob Storage または Azure Data Lake Store アカウントに自動的に配信します。時間またはサイズの間隔は柔軟に指定できます。 ラボではこの機能は必要ありません。

1. Azure Hubs インスタンスを作成するには、 **[作成]** をクリックし、リソースのデプロイを待ちます。

### <a name="exercise-5-create-real-time-message-route"></a>エクササイズ 5:リアルタイムのメッセージ ルートを作成する

Event Hubs 名前空間と Event Hubs サービスを作成したので、IoT Hub から Event Hubs にテレメトリ データを渡す必要があります。

#### <a name="task-1-create-the-telemetry-route"></a>タスク 1:製品利用統計情報ルートを作成する

このタスクでは、作成したばかりの Event Hubs インスタンスに製品利用統計情報メッセージを送信するメッセージ ルートを IoT Hub に追加します。

1. Azure portal ダッシュボードに移動します。

1. リソース タイルで、Azure IoT Hub を開くには、 **[iot-az220-training-{your-id}]** をクリックします。

    IoT Hub の **[概要]** ウィンドウが表示されます。

1. **[概要]** ペインで左側のメニューにある **[メッセージング]** で **[メッセージ ルーティング]** をクリックします。

1. **[メッセージ ルーティング]** ウィンドウで、新しいメッセージ ルートを追加するには、 **[+ 追加]** をクリックします。

1. **[ルートの追加]** ブレードの **[名前]** で「**vibrationTelemetryRoute**」と入力します。

1. **[エンドポイント]** ドロップダウンの右側で **[+ エンドポイントの追加]** をクリックした後、 **[イベント ハブ]** をクリックします。

1. **[イベント ハブ エンドポイントの追加]** ブレードの **[エンドポイント名]** で「 **[vibrationTelemetryEndpoint]** 」と入力します。

1. **[イベント ハブの名前空間]** で、先ほど作成した名前空間を選択します。

    **vibrationNamespacecah191212** のようになります

1. **[イベント ハブ インスタンス]** で、 **[vibrationeventhubinstance]** をクリックします。

1. エンドポイントを作成するには、 **[作成]** をクリックし、成功メッセージを待ちます。

    **[ルートの追加]** ブレードに戻り、 **[エンドポイント]** の値が更新されます。

1. **[ルートの追加]** ブレードの **[データソース]** で、 **[デバイス テレメトリ メッセージ]** が選択されていることを確認します。

1. **[ルートを有効にする]** で、 **[有効]** が選択されていることを確認します。

1. **[クエリのルーティング]** で、既存のクエリを次のクエリに置き換えます。

    ```sql
    sensorID = 'VSTel'
    ```

    前のクエリで 'VSLog' メッセージをログ ストレージに送信したことを覚えていますか。 このメッセージ ルートは、"VSTel" (製品利用統計情報) を Event Hubs インスタンスに送信します。

1. メッセージ ルートを作成するには、 **[保存]** をクリックします。

1. **[メッセージ ルーティング]** ブレードが表示されたら、次に一致する 2 つのルートがあることを確認します。

    | Name | Data Source | ルーティング クエリ | エンドポイント | Enabled |
    |:-----|:------------|:--------------|:---------|:--------|
    |vibrationLoggingRoute|DeviceMessages|sensorID = 'VSLog'|vibrationLogEndpoint|true|
    |vibrationTelemetryRoute|DeviceMessages|sensorID = 'VSTel'|vibrationTelemetryEndpoint|true|

Azure Stream Analytics のジョブを更新して、リアルタイム デバイス テレメトリを提供する準備ができました。

### <a name="exercise-6-add-telemetry-route"></a>演習 6: テレメトリのルートを追加する

この新しい IoT Hub ルートが整い、テレメトリ データがイベント ハブにストリーミングされた場合は、Stream Analytics ジョブを更新する必要があります。 このジョブは、イベント ハブからのデータを使用し、**AnomalyDetection_SpikeAndDip** ML モデルを使用して分析し、結果を Power BI に出力する必要があります。

#### <a name="task-1-add-a-new-input-to-the-job"></a>タスク 1:ジョブに新しい入力を追加

1. Azure portal のダッシュボードに戻ります。

1. リソース タイルで、 **[vibrationJob]** をクリックします。

    これは、前のラボで作成した Stream Analytics ジョブです。

    **[Stream Analytics ジョブ]** ブレードが開き、 **[概要]** ウィンドウが表示されます。

    > **注**:ジョブの状態が **[停止]** になっていることを確認します。

1. 左側のナビゲーション メニューの **[ジョブ トポロジ]** で、 **[入力]** をクリックします。

1. **[入力]** ペインで、 **[+ ストリーム入力の追加]** をクリックし、 **[イベント ハブ]** をクリックします。

1. **[イベント ハブ]** ウィンドウの **[入力エイリアス]** で「**vibrationEventInput**」と入力します

1. **[サブスクリプションからイベント ハブを選択する]** が選択されていることを確認します。

1. **[サブスクリプション]** で、このコースで使用していたサブスクリプションが選択されていることを確認します。

1. **[イベント ハブの名前空間]** で、前のセクションで入力した **vibrationNamespace [your-id}** 名前空間が選択されていることを確認します。

1. **[イベント ハブ名]** で **[既存の名前を使用する]** が選択され、前のセクションで作成したイベント ハブのインスタンスが選択されていることを確認します。

    **vibrationeventhubinstance** はすでに選択されているはずです。

1. **[イベント ハブ コンシューマー グループ]** の **[既存を使用]** をクリックし、 **$Default** が選択されていることを確認します。

1. 認証モード のドロップダウンで **接続文字列** が選択されていることを確認します。

1. **[イベント ハブ ポリシー名]** の **[既存を使用]** をクリックし、ドロップダウンで **[RootManageSharedAccessKey]** が選択されていることを確認します。

    > **注**:**イベント ハブ ポリシー キー** は、読み取り専用で設定されます。

1. **[イベントのシリアル化形式]** で **[JSON]** が選択されていることを確認します。

1. **[エンコード]** で、 **[UTF-8]** が選択されていることを確認します。

1. **[イベント圧縮のタイプ]** で **[なし]** が選択されていることを確認します。

1. 新しい入力を保存するには、 **[保存]** をクリックし、入力が作成されるまで待ちます。

    **入力** の一覧を更新し、新しい入力、**vibrationEventInput** を表示する必要があります。

#### <a name="task-2-add-a-new-output"></a>タスク 2:新しいアウトプットを追加

1. 左側のメニューの **[ジョブ トポロジ]** で、 **[出力]** をクリックします。

    **[出力]** ペインが表示されます。

1. **出力** ペインで、 **[+ 追加]** をクリックし、 **[Power BI]** をクリックします。

    **Power BI** ウィンドウが表示されます。

1. 以前に作成した Power BI アカウント (または既存のアカウント) を使用して接続を承認します。

1. **[Power BI - 新しい出力]** ウィンドウの **[出力エイリアス]** で「**vibrationBI**」と入力します。

1. **[グループ ワークスペース]** で、使用するワークスペースを選択します。

    これが新しいアカウントである場合、このドロップダウンはグレー表示されます。既存のアカウントがある場合は、適切なワークスペースを選択するか、講師にサポートを依頼してください。

1. **[データセット名]** で「**vibrationDataset**」と入力します。

1. **[テーブル名]** に「**vibrationTable**」と入力します。

1. **[認証モード]** の **[ユーザー トークン]** をクリックし、アクセスの取り消しに関するメモを読みます。

1. 出力を作成するには、 **[保存]** をクリックし、出力が作成されるのを待ちます。

    **出力** リストが新しい出力で更新されます。

#### <a name="task-3-update-the-sql-query-for-the-job"></a>タスク 3:ジョブの SQL クエリを更新する

1. 左側のメニューの **[ジョブ トポロジ]** で、 **[クエリ]** をクリックします。

1. 次の SQL クエリをコピーして、既存の短いクエリの *上に* 貼り付けます。

    ```sql
    WITH AnomalyDetectionStep AS
    (
        SELECT
            EVENTENQUEUEDUTCTIME AS time,
            CAST(vibration AS float) AS vibe,
            AnomalyDetection_SpikeAndDip(CAST(vibration AS float), 95, 120, 'spikesanddips')
                OVER(LIMIT DURATION(second, 120)) AS SpikeAndDipScores
        FROM vibrationEventInput
    )
    SELECT
        time,
        vibe,
        CAST(GetRecordPropertyValue(SpikeAndDipScores, 'Score') AS float) AS
        SpikeAndDipScore,
        CAST(GetRecordPropertyValue(SpikeAndDipScores, 'IsAnomaly') AS bigint) AS
        IsSpikeAndDipAnomaly
    INTO vibrationBI
    FROM AnomalyDetectionStep
    ```

    > **注**:このクエリの最初のセクションでは、振動データを受け取り、前の 120 秒分を調べます。 `AnomalyDetection_SpikeAndDip` 関数では、`Score` パラメーター、および `IsAnomaly` パラメーターが返されます。 スコアは、特定の値が異常であることを示す、ML モデルがどの程度信頼できるかを、パーセンテージで指定したものです。 スコアが 95% を超えた場合、`IsAnomaly` パラメーターの値は 1 になります。それ以外の場合は、`IsAnomaly` の値が 0 になります。 クエリの最初のセクションの 120 と 95 のパラメーターに注目してください。 クエリの 2 番目のセクションでは、時間、振動、および異常のパラメーターを `vibrationBI` に送信します。

1. クエリ エディターに 2 つの入力と出力が表示されていることを確認します。

    * `Inputs`
      * `vibrationEventInput`
      * `vibrationInput`
    * `Outputs`
      * `vibrationBI`
      * `vibrationOutput`

    それぞれ 2 つ超が表示される場合は、クエリ、または入力や出力で使用した名前に入力ミスがある可能性があります。続行する前にこの問題を修正してください。

1. クエリを保存するには、 **[クエリの保存]** をクリックします。

1. 左側のメニューで **[概要]** をクリックします。

1. ブレードの上部で、 **[開始]** をクリックします。

1. **[ジョブの開始]** ペインの **[ジョブ出力の開始時刻]** で、 **[今すぐ]** が選択されていることを確認し、 **[開始]** をクリックします。

人間のオペレーターがこのクエリからの出力を簡単に解釈できるようにするには、わかりやすい方法でデータを視覚化する必要があります。 この視覚化を行う方法の 1 つは、Power BI ダッシュボードを作成することです。

### <a name="exercise-7-create-a-power-bi-dashboard"></a>演習 7: Power BI ダッシュボードの作成

シナリオの最後の部分は、実際のデータの視覚化です。 ML モデルを介して振動製品利用統計情報を処理し、Power BI に結果を出力できるようジョブを更新しました。 Power BI 内で、結果を視覚化し、オペレーターに意思決定サポートを提供するため、多数のタイルを含むダッシュボードを作成する必要があります。

#### <a name="task-1-create-a-new-dashboard"></a>タスク 1:新しいダッシュボードを作成する

1. ブラウザーで [https://app.powerbi.com/](https://app.powerbi.com/) にアクセスします。

1. Power BI が開いたら、左側のナビゲーション メニューで **[ワークスペース]** を展開し、上記で指定したワークスペースを選択します。

    > **注**:執筆時点で、Power BI はプレビューで *新しい外観* になっています。 このタスクの手順は、*新しい外観* が **オフ** になっているものと仮定して作成されています。 *新しい外観* をオフにするには、スクリーン最上部のツールバーでトグルが **[新しい外観オフ]** になっていることを確認します。

1. **[データセット]** タブに **vibrationDataset** が表示されていることを確認します。

    表示されていない場合は、このリストが設定されるまでしばらく待つ必要がある場合があります。

1. ページの右上で **[+ 作成]** をクリックし、 **[ダッシュボード]** をクリックします。

1. **[ダッシュボードの作成]** ポップアップの **[ダッシュボード名]** で「**振動ダッシュ**」と入力し、 **[作成]** をクリックします。

    新しいダッシュボードは、基本的に空白のページとして表示されます。

#### <a name="task-2-add-the-vibration-gauge-tile"></a>タスク 2:振動ゲージ タイルを追加する

1. 振動ゲージを追加するには、空白のダッシュボードの上部にある **[+ タイルの追加]** をクリックします。

1. **[タイルの追加]** ウィンドウの **[リアルタイム データ]** で、 **[カスタム ストリーミング データ]** 、 **[次へ]** の順にクリックします。

1. **[カスタム ストリーミング データ タイルの追加]** ウィンドウの **[データセット]** の下で、 **[振動データセット]** 、 **[次へ]** の順にクリックします。

    ウィンドウが更新されると、視覚化の種類とフィールドを選択できます。

1. **[振動の種類]** の下のドロップダウンを開き、 **[ゲージ]** をクリックします。

    視覚化の種類を変更すると、以下のフィールドが変更されることに注意してください。

1. **[値]** の **[値の追加]** をクリックし、ドロップダウンを開いて **[Vibe]** をクリックします。

    更新される値を含むゲージがダッシュボードにすぐに表示されます。

1. タイルの詳細 ウィンドウを表示するには、**次へ** をクリックします。

1. **[タイルの詳細]** ウィンドウで、 **[タイトル]** の下に「**Vibration**」と入力します。

1. 残りのフィールドを既定値のままにしてウィンドウを閉じるには、 **[適用]** をクリックします。

    Phone ビューの作成に関する通知が表示された場合は、それを無視して構いません。すぐに消えます (または自分で消します)。

1. タイルのサイズを小さくするには、タイルの右下隅にマウス オーバーし、マウス ポインタのサイズ変更をクリックしてドラッグします。

    タイルをできるだけ小さくします。 それはさまざまなプリセット サイズになります。

#### <a name="task-3-add-the-spikeanddipscore-clustered-bar-chart-tile"></a>タスク 3:SpikeAndDipScore 集合横棒グラフ タイルを追加する

1. SpikeAndDipScore 集合横棒グラフを追加するには、空白のダッシュボードの上部にある **[+ タイルの追加]** をクリックします。

1. **[タイルの追加]** ウィンドウの **[リアルタイム データ]** で、 **[カスタム ストリーミング データ]** 、 **[次へ]** の順にクリックします。

1. **[カスタム ストリーミング データ タイルの追加]** ウィンドウの **[データセット]** の下で、 **[振動データセット]** 、 **[次へ]** の順にクリックします。

1. **[視覚化の種類]** でドロップダウンを開き、 **[集合横棒グラフ]** をクリックします。

    視覚化の種類を変更すると、以下のフィールドが変更されることに注意してください。

1. **[値]** の **[値の追加]** をクリックし、ドロップダウンを開いたら、 **[SpikeAndDipScore]** をクリックします。

1. タイルの詳細 ウィンドウを表示するには、**次へ** をクリックします。

1. タイルの詳細 ウィンドウを閉じるには、**適用** をクリックします。

    Phone ビューの作成に関する通知が表示された場合は、それを無視して構いません。すぐに消えます (または自分で消します)。

1. さらにタイルのサイズを小さくして、できるだけ小さくします。

#### <a name="task-4-add-the-isspikeanddipanomaly-card-tile"></a>タスク 4:IsSpikeAndDipanomaly カード タイルを追加する

1. ダッシュボードの上部にある IsSpikeAndDipAnomaly カードの視覚化を追加するには、 **[+ タイルを追加]** をクリックします。

1. **[タイルの追加]** ウィンドウの **[リアルタイム データ]** で、 **[カスタム ストリーミング データ]** 、 **[次へ]** の順にクリックします。

1. **[カスタム ストリーミング データ タイルの追加]** ウィンドウの **[データセット]** の下で、 **[vibrationDatset]** 、 **[次へ]** の順にクリックします。

1. **[視覚化の種類]** の下のドロップダウンを開き、 **[カード]** をクリックします。

1. **[値]** の下の **[値の追加]** をクリックし、ドロップダウンを開いて **[IsSpikeAndDipAnomaly]** をクリックします。

1. タイルの詳細 ウィンドウを表示するには、**次へ** をクリックします。

1. **[タイルの詳細]** ウィンドウで、 **[タイトル]** の下に「**異常ですか?** 」と入力します

1. タイルの詳細 ウィンドウを閉じるには、**適用** をクリックします。

    Phone ビューの作成に関する通知が表示された場合は、それを無視して構いません。すぐに消えます (または自分で消します)。

1. さらにタイルのサイズを小さくして、できるだけ小さくします。

#### <a name="task-5-rearrange-the-tiles"></a>タスク 5:タイルの並べ替え

1. ドラッグ アンド ドロップを使用して、次の順序でダッシュボードの左側のタイルを縦に並べます。

    * SpikeAndDipScore
    * 異常ですか?
    * 振動

#### <a name="task-6-add-anomalies-over-the-hour-line-chart-tile"></a>タスク 6:時刻上の異常の折れ線グラフ タイルを追加する

次に、4 番目のタイルである `Anomalies Over the Hour` 折れ線グラフを作成します。  これは、もう少し複雑です。

1. ダッシュボードの上部にある **[+ タイルの追加]** をクリックします。

1. **[タイルの追加]** ウィンドウの **[リアルタイム データ]** で、 **[カスタム ストリーミング データ]** 、 **[次へ]** の順にクリックします。

1. **[カスタム ストリーミング データ タイルの追加]** ウィンドウの **[データセット]** の下で、 **[振動データセット]** 、 **[次へ]** の順にクリックします。

    ウィンドウが更新されると、視覚化の種類とフィールドを選択できます。

1. **[視覚化の種類]** の下のドロップダウンを開き、 **[折れ線グラフ]** をクリックします。

    視覚化の種類を変更すると、以下のフィールドが変更されることに注意してください。

1. **[軸]** の下の **[値の追加]** をクリックし、ドロップダウンの **[時刻]** を選択します。

1. **[値]** の下で **[値の追加]** をクリックし、ドロップダウンの **[IsSpikeAndDipAnomaly]** を選択します。

    更新される値を含むグラフがダッシュボードにすぐに表示されることに注意してください。

1. **[表示する時間枠]** で、 **[過去]** の右側でドロップダウンを開き、 **[60]** をクリックします。

    単位は **[分]** に設定したままにします。

1. タイルの詳細 ウィンドウを表示するには、**次へ** をクリックします。

1. **[タイルの詳細]** ウィンドウの **[タイトル]** の下に「**1 時間にわたる異常**」と入力します。

1. タイルの詳細 ウィンドウを閉じるには、**適用** をクリックします。

    Phone ビューの作成に関する通知が表示された場合は、それを無視して構いません。すぐに消えます (または自分で消します)。

1. 今回は、タイルの高さが左の 3 つのタイルと一致し、その幅がダッシュボードの残りのスペースに合うようにタイルを広げます。

    非常に多くのルートと接続の遅延がありますが、視覚化された振動データが表示されるはずです

    > **注**:データが表示されていない場合は、デバイス アプリを実行していて、分析ジョブが実行されていることを確認します。

    ML モデルが開始される前の少なくとも数分間、ジョブを実行します。 デバイス アプリのコンソール出力を、Power BI ダッシュボードと比較します。 強制振動と増幅振動を、異常検出の実行に関連付けることはできますか?

アクティブな Power BI ダッシュボードが表示されていれば、このラボは完了です。 順調です。

> **注**:先に進む前に、Visual Studio Code を終了することを忘れないでください。この操作により、デバイス アプリがまだ実行している場合は、それを終了させます。
